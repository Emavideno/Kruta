<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Kruta.GUI.ViewModels"
             xmlns:models="clr-namespace:Kruta.GUI2.Models.Cards"
             xmlns:sys="clr-namespace:System;assembly=netstandard"
             x:Class="Kruta.GUI.MainPage"
             Title="Крутагидон: Магия и Беспредел">

    <ContentPage.BindingContext>
        <viewmodels:MainViewModel />
    </ContentPage.BindingContext>

    <ContentPage.Resources>
        <ResourceDictionary>
            <viewmodels:BoolToColorConverter x:Key="BoolToColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *">
        <Label Grid.Row="0" Text="{Binding ConnectionStatus}" 
               BackgroundColor="#333" TextColor="White" Padding="10" 
               HorizontalOptions="FillAndExpand" HorizontalTextAlignment="Center"/>

        <Grid Grid.Row="1">

            <Grid ColumnDefinitions="*, 300" RowDefinitions="Auto, 1.5*, 2*, 1.5*" Padding="10"
                  x:Name="GameTableLayout">

                <StackLayout Grid.Row="0" Grid.ColumnSpan="2" Orientation="Horizontal" BackgroundColor="#E0E0E0" Padding="5">
                    <Label Text="{Binding IsMyTurn, StringFormat='ВАШ ХОД: {0}'}" FontAttributes="Bold" TextColor="{Binding IsMyTurn, Converter={StaticResource BoolToColorConverter}}"/>
                    <Label Text="{Binding LocalPlayer.CurrentHealth, StringFormat=' | Ваше Здоровье: {0}'}"/>
                    <Label Text="{Binding CurrentPower, StringFormat=' | Ваша Мощь: {0}'}" FontAttributes="Bold" TextColor="Green"/>
                    <Label Text="{Binding CurrentGameState.CurrentLegend.Name, StringFormat=' | Легенда: {0} (Стоимость: {1} Мощи)'}"/>
                    <Label Text="{Binding CurrentGameState.CurrentLegend.GroupAttackText, StringFormat=' | Групповая Атака: {0}'}" FontAttributes="Italic"/>
                </StackLayout>

                <StackLayout Grid.Row="1" Grid.Column="1" Grid.RowSpan="2" Spacing="15" Padding="10" BackgroundColor="#DDDDDD">
                    <Label Text="Соперники" FontAttributes="Bold" FontSize="Medium"/>

                    <CollectionView ItemsSource="{Binding OpponentPlayers}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="viewmodels:Player">
                                <StackLayout Margin="0, 0, 0, 10" Padding="5" BackgroundColor="#F5F5F5">
                                    <Label Text="{Binding Name}" FontAttributes="Bold" TextColor="Navy"/>
                                    <Label Text="{Binding CurrentHealth, StringFormat='Жизни: {0}'}" FontSize="Small"/>
                                    <Label Text="{Binding PropertyToken.Text, StringFormat='Свойство: {0}'}" FontSize="Small" LineBreakMode="WordWrap"/>

                                    <Label Text="{Binding InitialFamiliar.Name, StringFormat='Фамильяр: {0}'}" FontSize="Small" FontAttributes="Italic"/>
                                    <Label Text="{Binding InitialFamiliar.Text}" FontSize="Micro" LineBreakMode="WordWrap"/>

                                    <Label Text="Постоянка в игре:" FontSize="Micro" Margin="0, 5, 0, 0"/>
                                    <CollectionView ItemsSource="{Binding Permanents}" HeightRequest="40">
                                        <CollectionView.ItemsLayout>
                                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="2"/>
                                        </CollectionView.ItemsLayout>
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="models:Card">
                                                <Label Text="{Binding Name}" FontSize="Micro" BackgroundColor="#A0E0A0" Padding="2, 0"/>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                </StackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </StackLayout>

                <StackLayout Grid.Row="1" Grid.Column="0" Orientation="Vertical">
                    <Label Text="Барахолка (Покупка)" FontAttributes="Bold"/>
                    <CollectionView ItemsSource="{Binding BaraholkaCards}" HeightRequest="150" HorizontalScrollBarVisibility="Always">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="10"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Card">
                                <StackLayout BackgroundColor="#F0F0F0" Padding="5" WidthRequest="120">
                                    <Label Text="{Binding Name}" FontAttributes="Bold" LineBreakMode="WordWrap" MaxLines="2"/>
                                    <Label Text="{Binding Type}" FontSize="Micro" TextColor="DarkGray"/>
                                    <Label Text="{Binding BuyCost, StringFormat='Цена: {0}'}" TextColor="Red"/>
                                    <Label Text="{Binding PowerValue, StringFormat='Мощь: {0}'}" TextColor="Green"/>
                                    <Label Text="{Binding Text}" FontSize="Micro" LineBreakMode="TailTruncation" MaxLines="3"/>
                                    <Button Text="Купить" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=BuyCardFromBaraholkaCommand}" 
                                            CommandParameter="{Binding .}" IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=IsMyTurn}"/>
                                </StackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </StackLayout>

                <Grid Grid.Row="2" Grid.Column="0" ColumnDefinitions="*, *" RowDefinitions="Auto, *">
                    <Label Grid.Row="0" Grid.Column="0" Text="Общие Стопки (Шальная Магия, Вялые Палочки)" FontAttributes="Bold"/>
                    <Label Grid.Row="0" Grid.Column="1" Text="Ваши Сыгранные Карты / Постоянка" FontAttributes="Bold"/>

                    <StackLayout Grid.Row="1" Grid.Column="0" Orientation="Horizontal" Spacing="15" Padding="5">
                        <StackLayout BackgroundColor="#D0E0FF" Padding="5">
                            <Label Text="Шальная Магия" FontAttributes="Bold" FontSize="Small"/>
                            <Label Text="{Binding CurrentGameState.WildMagicStack.Count, StringFormat='{0} Карт'}" FontSize="Micro"/>
                            <Button Text="Купить (3)" Command="{Binding BuyWildMagicCommand}" IsEnabled="{Binding IsMyTurn}" BackgroundColor="#6495ED"/>
                        </StackLayout>
                        <StackLayout BackgroundColor="#FFEBCD" Padding="5">
                            <Label Text="Вялые Палочки" FontAttributes="Bold" FontSize="Small"/>
                            <Label Text="{Binding CurrentGameState.SlothWandsStack.Count, StringFormat='{0} Карт'}" FontSize="Micro"/>
                        </StackLayout>
                        <StackLayout BackgroundColor="#FFD700" Padding="5">
                            <Label Text="Жетоны Дохлых" FontAttributes="Bold" FontSize="Small"/>
                            <Label Text="{Binding CurrentGameState.DeadWizardTokensStack.Count, StringFormat='Осталось: {0}'}" FontSize="Micro"/>
                        </StackLayout>
                    </StackLayout>

                    <CollectionView Grid.Row="1" Grid.Column="1" ItemsSource="{Binding PlayedCards}" HorizontalScrollBarVisibility="Always">
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Horizontal" ItemSpacing="5"/>
                        </CollectionView.ItemsLayout>
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Card">
                                <StackLayout BackgroundColor="#D0D0FF" Padding="5" WidthRequest="100">
                                    <Label Text="{Binding Name}" FontAttributes="Bold" LineBreakMode="WordWrap" MaxLines="2"/>
                                    <Label Text="{Binding PowerValue, StringFormat='Мощь: {0}'}" TextColor="Green"/>
                                    <Label Text="{Binding Text}" FontSize="Micro" LineBreakMode="TailTruncation" MaxLines="3"/>
                                    <Label Text="ПОСТОЯНКА" FontSize="Micro" TextColor="Blue" IsVisible="{Binding IsPermanent}"/>
                                </StackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>


                <Grid Grid.Row="3" Grid.Column="0" ColumnDefinitions="*, Auto" Grid.ColumnSpan="2" BackgroundColor="#EFEFEF" Padding="5">

                    <VerticalStackLayout Grid.Column="1" Spacing="5" WidthRequest="150" Padding="5">
                        <Button Text="Наебашить Легенде" Command="{Binding AttackLegendCommand}" IsEnabled="{Binding IsMyTurn}" BackgroundColor="DarkRed"/>
                        <Button Text="Купить Фамильяра (6)" Command="{Binding BuyFamiliarCommand}" IsEnabled="{Binding IsMyTurn}" BackgroundColor="Orange"/>
                        <BoxView HeightRequest="1" Color="Gray"/>
                        <Button Text="Завершить Ход" Command="{Binding EndTurnCommand}" 
                            BackgroundColor="{Binding IsMyTurn, Converter={StaticResource BoolToColorConverter}}"
                            IsEnabled="{Binding IsMyTurn}"/>
                    </VerticalStackLayout>

                    <StackLayout Grid.Column="0" Orientation="Vertical">
                        <Label Text="Ваша Рука (Нажмите, чтобы сыграть)" FontAttributes="Bold"/>
                        <CollectionView ItemsSource="{Binding HandCards}" HeightRequest="150" HorizontalScrollBarVisibility="Always">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Horizontal" ItemSpacing="10"/>
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:Card">
                                    <StackLayout BackgroundColor="#FFFACD" Padding="5" WidthRequest="120">
                                        <Label Text="{Binding Name}" FontAttributes="Bold" LineBreakMode="WordWrap" MaxLines="2"/>
                                        <Label Text="{Binding PowerValue, StringFormat='+{0} Мощи'}" TextColor="Green"/>
                                        <Label Text="{Binding Text}" FontSize="Small" LineBreakMode="TailTruncation" MaxLines="4"/>
                                        <Button Text="Сыграть" Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=PlayCardCommand}" 
                                                CommandParameter="{Binding .}" IsEnabled="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=IsMyTurn}"/>
                                    </StackLayout>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </StackLayout>
                </Grid>
            </Grid>
        </Grid>
    </Grid>
</ContentPage>