<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Kruta.GUI2.ViewModels"
             x:Class="Kruta.GUI2.Views.PlayPage"
             x:Name="ThisPage"
             BackgroundColor="#1B3F2F"
             Title="Игровое поле">

    <ContentPage.Resources>
        <!-- Стили -->
        <Style x:Key="HealthLabelStyle" TargetType="Label">
            <Setter Property="TextColor" Value="#FF4C4C" />
            <Setter Property="FontAttributes" Value="Bold" />
            <Setter Property="FontSize" Value="14" />
            <Setter Property="HorizontalOptions" Value="Center" />
        </Style>

        <Style x:Key="HealthBadgeStyle" TargetType="Frame">
            <Setter Property="Padding" Value="5,2" />
            <Setter Property="BackgroundColor" Value="#30000000" />
            <Setter Property="BorderColor" Value="Red" />
            <Setter Property="CornerRadius" Value="5" />
            <Setter Property="HorizontalOptions" Value="Center" />
            <Setter Property="HasShadow" Value="False" />
        </Style>

        <Style x:Key="OpponentCardBase" TargetType="Rectangle">
            <Setter Property="WidthRequest" Value="45" />
            <Setter Property="HeightRequest" Value="70" />
            <Setter Property="RadiusX" Value="5" />
            <Setter Property="RadiusY" Value="5" />
            <Setter Property="StrokeThickness" Value="2" />
            <Setter Property="Fill" Value="#8B0000" />
            <Setter Property="Stroke" Value="#550000" />
            <Setter Property="Opacity" Value="0.6" />
        </Style>

        <Style x:Key="MyCardStyle" TargetType="Frame">
            <Setter Property="WidthRequest" Value="80" />
            <Setter Property="HeightRequest" Value="140" />
            <Setter Property="BackgroundColor" Value="White" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="HasShadow" Value="True" />
            <Setter Property="BorderColor" Value="Gray" />
        </Style>

        <Style x:Key="AttackButtonStyle" TargetType="Button">
            <Setter Property="Text" Value="АТАКА" />
            <Setter Property="BackgroundColor" Value="#8B0000" />
            <Setter Property="TextColor" Value="White" />
            <Setter Property="FontSize" Value="10" />
            <Setter Property="HeightRequest" Value="30" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="CornerRadius" Value="5" />
            <Setter Property="Command" Value="{Binding Source={x:Reference ThisPage}, Path=BindingContext.AttackOpponentCommand}" />
            <Setter Property="CommandParameter" Value="{Binding Name}" />
        </Style>

        <!-- Шаблон карты руки -->
        <DataTemplate x:Key="HandCardTemplate">
            <Frame Style="{StaticResource MyCardStyle}" BorderColor="Gold" BackgroundColor="#F0F0F0">
                <VerticalStackLayout Spacing="2" Padding="2">
                    <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="12" HorizontalTextAlignment="Center"/>
                    <ScrollView HeightRequest="80">
                        <VerticalStackLayout Spacing="1">
                            <Label Text="{Binding Damage, StringFormat='Урон: {0}'}" FontSize="10" TextColor="Red"/>
                            <Label Text="{Binding HealthBonus, StringFormat='Лечение: {0}'}" FontSize="10" TextColor="Green"/>
                            <Label Text="{Binding PowerBonus, StringFormat='Мощь: {0}'}" FontSize="10" TextColor="Cyan"/>
                            <Label Text="{Binding DrawCount, StringFormat='Добор: {0}'}" FontSize="10" TextColor="Purple"/>
                            <Label Text="{Binding Description}" FontSize="9" TextColor="Black" LineBreakMode="WordWrap"/>
                        </VerticalStackLayout>
                    </ScrollView>
                    <HorizontalStackLayout Spacing="5">
                        <Button Text="СЫГРАТЬ" 
                                Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.PlayCardCommand}" 
                                CommandParameter="{Binding .}"
                                FontSize="10"
                                Margin="2"
                                BackgroundColor="Gold"
                                TextColor="Black"
                                CornerRadius="5"
                                IsEnabled="{Binding Source={x:Reference ThisPage}, Path=BindingContext.CanPlaySelectedCard}"/>
                        <Button Text="ЦЕЛЬ" 
                                Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.SelectTargetCommand}"
                                CommandParameter="{Binding .}"
                                FontSize="10"
                                Margin="2"
                                BackgroundColor="#8B0000"
                                TextColor="White"
                                CornerRadius="5"/>
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Frame>
        </DataTemplate>

        <!-- Шаблон карты Барахолки -->
        <DataTemplate x:Key="BaraholkaCardTemplate">
            <Frame Style="{StaticResource MyCardStyle}" BorderColor="Silver" BackgroundColor="#E0E0E0">
                <VerticalStackLayout Spacing="2" Padding="2">
                    <Label Text="{Binding Name}" FontAttributes="Bold" FontSize="12" HorizontalTextAlignment="Center"/>
                    <ScrollView HeightRequest="80">
                        <VerticalStackLayout Spacing="1">
                            <Label Text="{Binding Cost, StringFormat='Стоимость: {0}'}" FontSize="10" TextColor="DarkGoldenrod"/>
                            <Label Text="{Binding Damage, StringFormat='Урон: {0}'}" FontSize="10" TextColor="Red"/>
                            <Label Text="{Binding HealthBonus, StringFormat='Лечение: {0}'}" FontSize="10" TextColor="Green"/>
                            <Label Text="{Binding PowerBonus, StringFormat='Мощь: {0}'}" FontSize="10" TextColor="Cyan"/>
                            <Label Text="{Binding DrawCount, StringFormat='Добор: {0}'}" FontSize="10" TextColor="Purple"/>
                            <Label Text="{Binding Description}" FontSize="9" TextColor="Black" LineBreakMode="WordWrap"/>
                        </VerticalStackLayout>
                    </ScrollView>
                </VerticalStackLayout>
            </Frame>
        </DataTemplate>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto, *, Auto" 
          ColumnDefinitions="120, *, 120" 
          Padding="10">

        <!-- Центр и Барахолка -->
        <VerticalStackLayout Grid.Row="1" Grid.Column="1" VerticalOptions="Center" HorizontalOptions="Center" Spacing="5">
            <Label Text="KRUTA" FontSize="40" FontAttributes="Bold" TextColor="White" Opacity="0.1" HorizontalOptions="Center" />
            <Label Text="{Binding GameStatus}" FontSize="18" TextColor="Yellow" FontAttributes="Bold" HorizontalOptions="Center" />

            <Grid ColumnDefinitions="80, *" HorizontalOptions="Center" WidthRequest="550" HeightRequest="160">
                <VerticalStackLayout Grid.Column="0" VerticalOptions="Center" Spacing="5">
                    <Frame BackgroundColor="#2C3E50" BorderColor="Goldenrod" CornerRadius="5" WidthRequest="60" HeightRequest="90" Padding="0">
                        <Label Text="DECK" TextColor="White" HorizontalOptions="Center" VerticalOptions="Center" FontAttributes="Bold" Rotation="-45"/>
                    </Frame>
                    <Label Text="{Binding DeckRemainingCount, StringFormat='Карт: {0}'}" TextColor="Yellow" HorizontalOptions="Center" FontAttributes="Bold" FontSize="12"/>
                </VerticalStackLayout>

                <!-- Барахолка -->
                <CollectionView Grid.Column="1" 
                                ItemsSource="{Binding BaraholkaCards}" 
                                ItemTemplate="{StaticResource BaraholkaCardTemplate}"
                                HorizontalScrollBarVisibility="Never"
                                VerticalScrollBarVisibility="Never">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Horizontal" ItemSpacing="10" />
                    </CollectionView.ItemsLayout>
                </CollectionView>
            </Grid>
        </VerticalStackLayout>

        <!-- Верхний оппонент -->
        <VerticalStackLayout Grid.Row="0" Grid.Column="1" BindingContext="{Binding Opponents[0]}" VerticalOptions="Start" Spacing="5">
            <Label Text="{Binding Name}" TextColor="White" HorizontalOptions="Center" />
            <Button Style="{StaticResource AttackButtonStyle}">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding Source={x:Reference ThisPage}, Path=BindingContext.MyPower}" Value="0">
                        <Setter Property="IsVisible" Value="False"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding Source={x:Reference ThisPage}, Path=BindingContext.IsMyTurn}" Value="False">
                        <Setter Property="IsVisible" Value="False"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
            <Frame Style="{StaticResource HealthBadgeStyle}">
                <Label Text="{Binding Health, StringFormat='{0} HP'}" Style="{StaticResource HealthLabelStyle}" />
            </Frame>
        </VerticalStackLayout>

        <!-- Левый и правый оппоненты -->
        <VerticalStackLayout Grid.Row="1" Grid.Column="0" BindingContext="{Binding Opponents[1]}" VerticalOptions="Center" Rotation="90" Spacing="5">
            <Label Text="{Binding Name}" TextColor="White" HorizontalOptions="Center" />
            <Button Style="{StaticResource AttackButtonStyle}">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding Source={x:Reference ThisPage}, Path=BindingContext.MyPower}" Value="0">
                        <Setter Property="IsVisible" Value="False"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding Source={x:Reference ThisPage}, Path=BindingContext.IsMyTurn}" Value="False">
                        <Setter Property="IsVisible" Value="False"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
            <Frame Style="{StaticResource HealthBadgeStyle}">
                <Label Text="{Binding Health, StringFormat='{0} HP'}" Style="{StaticResource HealthLabelStyle}" />
            </Frame>
        </VerticalStackLayout>

        <VerticalStackLayout Grid.Row="1" Grid.Column="2" BindingContext="{Binding Opponents[2]}" VerticalOptions="Center" Rotation="-90" Spacing="5">
            <Label Text="{Binding Name}" TextColor="White" HorizontalOptions="Center" />
            <Button Style="{StaticResource AttackButtonStyle}">
                <Button.Triggers>
                    <DataTrigger TargetType="Button" Binding="{Binding Source={x:Reference ThisPage}, Path=BindingContext.MyPower}" Value="0">
                        <Setter Property="IsVisible" Value="False"/>
                    </DataTrigger>
                    <DataTrigger TargetType="Button" Binding="{Binding Source={x:Reference ThisPage}, Path=BindingContext.IsMyTurn}" Value="False">
                        <Setter Property="IsVisible" Value="False"/>
                    </DataTrigger>
                </Button.Triggers>
            </Button>
            <Frame Style="{StaticResource HealthBadgeStyle}">
                <Label Text="{Binding Health, StringFormat='{0} HP'}" Style="{StaticResource HealthLabelStyle}" />
            </Frame>
        </VerticalStackLayout>

        <!-- Нижняя панель игрока -->
        <VerticalStackLayout Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" VerticalOptions="End" Spacing="5">
            <Button Text="ЗАВЕРШИТЬ ХОД"
                    Command="{Binding Source={x:Reference ThisPage}, Path=BindingContext.EndTurnCommand}"
                    IsVisible="{Binding Source={x:Reference ThisPage}, Path=BindingContext.IsMyTurn}"
                    BackgroundColor="Gold" 
                    TextColor="Black" 
                    FontAttributes="Bold"
                    WidthRequest="220" 
                    HeightRequest="50" 
                    CornerRadius="25" 
                    HorizontalOptions="Center"/>
            <HorizontalStackLayout HorizontalOptions="Center" Spacing="15" Margin="0,5">
                <Label Text="ВАШИ КАРТЫ" TextColor="White" FontAttributes="Bold" VerticalOptions="Center"/>
                <Frame BorderColor="Lime" BackgroundColor="#2000FF00" Padding="10,2" HasShadow="False">
                    <Label Text="{Binding MyHealth, StringFormat='{0} HP'}" TextColor="Lime" FontAttributes="Bold" FontSize="16"/>
                </Frame>
                <Frame BorderColor="Cyan" BackgroundColor="#2000FFFF" Padding="10,2" HasShadow="False">
                    <HorizontalStackLayout Spacing="5">
                        <Label Text="⚡" VerticalOptions="Center" TextColor="Cyan" />
                        <Label Text="{Binding MyPower, StringFormat='{0} МОЩЬ'}" TextColor="Cyan" FontAttributes="Bold" FontSize="16"/>
                    </HorizontalStackLayout>
                </Frame>
            </HorizontalStackLayout>

            <!-- Рука игрока -->
            <CollectionView ItemsSource="{Binding MyHandCards}" 
                            ItemTemplate="{StaticResource HandCardTemplate}" 
                            HeightRequest="140"
                            VerticalOptions="End"
                            HorizontalScrollBarVisibility="Never">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal" ItemSpacing="8" />
                </CollectionView.ItemsLayout>
            </CollectionView>
        </VerticalStackLayout>
    </Grid>
</ContentPage>
